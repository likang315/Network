###  HTTP 高级特性

------

[TOC]

##### 01：HTTP 特性

​	只要一端没有明确的提出断开连接，则保持TCP连接，**HTTP/1.1所有连接默认都是持久连接**

- **管线化**：可以同时发送多个请求，解决了发送请求后需要等待并收到响应，才可以发送下一个请求；
- **Cookie技术**：通过在请求和响应中写入Cookie信息来得到之前的用户状态信息；
  - Cookie 会根据从服务器端发送的响应报文内一个Set-Cookie的首部字段信息通知客户端保存Cookie，当下次客户端再往该服务器发送请求时客户端会自动在请求报文中加入Cookie值后发送出去，服务器会检查是哪一个客户端发送的请求，然后对比服务器上的记录，得到状态信息
- **分块传输编码**：在传输大容量数据时，通过把数据分割为多块，能够让浏览器逐步显示页面；
- **恢复**：指能从之前下载中断处恢复下载，需指定范围请求；
- **内容协商机制**：客户端和服务器就响应的资源内容进行交涉，然后提供给客户端最为合适的资源；

##### 02：轮询机制

###### HTTP 长轮询

​	HTTP 长轮询是服务器收到请求后如果有数据, 立刻响应请求; 如果没有数据就会**等待一段时间**, 这段时间内如果有数据立刻响应请求，如果时间到了还没有数据, 则响应 HTTP 请求，浏览器收到 HTTP 响应后，**立即发送一个同样 HTTP 请求**查询是否有数据；

- HTTP 长轮询的局限
  1. 浏览器端对服务器**同时 HTTP 连接数有最大限制, 最好同一用户只存在一个长轮询**；
  2. 服务器端**没有数据等待连接时会造成资源浪费,** 容易产生服务器瓶颈；

###### HTTP 短轮询

​	HTTP 短轮询是服务器收到请求**不管是否有数据都直接响应 HTTP 请求**;浏览器收到 HTTP 响应隔一段时间再发送同样的 HTTP，请求查询数据；

- HTTP 短轮询的局限：实时性低

##### 03：缓存机制

- 根据是否需要重新向服务器发起请求来分类，分为强制缓存 和 对比缓存。

###### 已存在缓存数据时，仅基于强制缓存

- ![](/Users/likang/Code/Git/Network/02：HTTP/photos/force-cache.png)

###### 已存在缓存数据时，仅基于对比缓存

- ![](/Users/likang/Code/Git/Network/02：HTTP/photos/contrast-cache.png)
- 两类缓存规则的不同，强制缓存如果生效，不需要再和服务器发生交互，而对比缓存不管是否生效，都需要**与服务端发生交互，验证缓存是否有效**，并且两类缓存规则可以同时存在，**强制缓存优先级高于对比缓存**，也就是说，当执行强制缓存的规则时，如果缓存生效，直接使用缓存，不再执行对比缓存规则；

###### 强制缓存

- 通过 **Expires 和 Cache-Control** 来判断缓存数据是否失效；
- Expires （HTTP 1.0）
  - Expires : 值为服务端返回的到期时间，即下一次请求时，请求时间小于服务端返回的到期时间，直接使用缓存数据
  - 导致的问题：到期时间是由服务端生成的，但是客户端时间可能跟服务端时间有误差，这就会导致缓存命中的误差，所以HTTP 1.1 的版本，使用Cache-Control替代；
- **Cache-Contro（HTTP 1.1）**
  - Cache-Control：是最重要的规则，常见的取值有private、public、no-cache、max-age，no-store，**默认为private**
    - private：客户端可以缓存
    - public：客户端和代理服务器都可缓存
    - max-age=xxx：缓存的内容将在 xxx 秒后失效
    - no-cache：需要使用对比缓存来验证缓存数据
    - no-store：所有内容都不会缓存，强制缓存，对比缓存都不会触发

###### 对比缓存（协商缓存）

- 浏览器第一次请求数据时，服务器会将**缓存标识与数据**一起返回给客户端，客户端将二者备份至缓存中，再次请求数据时，**客户端将备份的缓存标识发送给服务器**，服务器根据缓存标识进行判断，**判断成功后，返回304状态码**，通知客户端比较成功，可以使用缓存数据；
- 通过 **Last-Modified  /  If-Modified-Since 和 Etag  /  If-None-Match（优先级高）**来判断缓存数据是否失效
- Last-Modified：
  - 服务器在响应请求时，**告知浏览器资源的最后修改时间**，比对修改时间，若是没有变动，服务器响应304 (Not Modified)，告知客户端可以使用缓存；
- Etag：
  - 服务器响应请求时，**告知浏览器当前资源在服务器的唯一标识（字符串）**（生成规则由服务器决定），对比标识是否相同；

##### 04：认证机制

- 证书：由第三方可靠的，权威的机构颁发的证书（保存 IP信息、证书过期时间、证书所有者地址信息)，证明自己是自己；

###### 双向认证

1. 先决条件是有两个或两个以上的证书，一个是服务端证书，另一个或多个是客户端证书；
2. 服务端保存着客户端的证书并信任该证书，客户端保存着服务端的证书并信任该证书，这样，在证书验证成功的情况下即可完成请求响应
3. 双向认证一般**企业应用对接**；

###### 单向认证

1. 客户端保存着服务端的证书并信任该证书即可；
2. HTTPS 一般是单向认证，这样可以让绝大部分人都可以访问你的站点；

