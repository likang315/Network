### NAT 技术

------

[TOC]

##### 01：NAT 技术（Network Address Translation）

- 网络地址转换：网络中用来将私有 IP 地址转换为公共 IP 地址的技术；
- 通过**在路由器维护一个转换表，将内部网络的地址映射到外部网络的地址**，从而隐藏了内部网络的真实结构。这种技术有助于**延缓 IPv4 地址枯竭**，同时提供了一定程度的安全性。

###### SNAT：源地址网络转换

- SNAT（**S**ource **N**etwork **A**ddress **T**ranslation）：是NAT的一个特定实现，用于**修改数据包的源 IP 地址**。它允许内部网络中的多个主机共享单个公共IP地址，通常是为了让内部网络访问互联网。

###### DNAT：目标网络地址转换

- DNAT(**D**estination **N**etwork **A**ddress **T**ranslation）：用于修改数据包的目标 IP 地址，允许**将传入数据包的目标IP地址更改为另一个地址**，通常用于在路由器上**重定向流量到内部网络中的特定主机或服务器**。这种技术通常用于实现端口转发或负载均衡等网络功能。

##### 04：NAPT

- NAPT（Network Address Port Translation）：是一种网络地址转换（NAT）技术，它**不仅修改数据包的源或目标IP地址，还会修改端口号**。
- 允许多个内部主机共享单个公共IP地址，并**通过端口号来区分不同的内部主机**。NAPT通常用于路由器上，以实现对外部网络的访问，同时保护内部网络的安全性。

###### NAT 表

- 每一个表项都是一条映射关系；

| 私有 IP     | 私有 IP 端口 | 公有 IP         | 公有端口 |
| ----------- | ------------ | --------------- | -------- |
| 192.168.0.1 | 1024         | 192.168.255.255 | 1000     |
| 192.168.0.2 | 1024         | 192.168.255.255 | 1001     |
|             |              |                 |          |

##### 05：内网穿透技术

- 因为 NAT 的存在，我们只能从内网主动发起连接（内网访问外网），否则**NAT设备不会记录相应的映射关系，没有映射关系也就不能转发数据**。
  - **没有什么是加中间层不能解决的，如果有，那就再加一层**
- 解决方式：在**公网上**加一台服务器x，并暴露一个访问域名，再让内网的服务**主动**连接服务器x，这样 NAT 路由器上就有对应的**映射关系**。接着，所有人都去访问服务器x，服务器x将数据转发给内网机器，再原路返回响应，这样数据就都通了。这就是所谓的**内网穿透**。

<img src="https://github.com/likang315/Network/blob/master/01：计算机网络/photos/nat.png?raw=true" alt="nat" style="zoom:50%;" />

##### 06：NAT 打洞：抛开第三方，直连通信

- 假设还是A和B两个**局域网内**的主机，A内网对应的NAT设备叫`NAT_A`，B内网里的NAT设备叫`NAT_B`，和一个第三方服务器`server`。

###### 流程如下

- **step1和2**: A主动去连server，此时A对应的`NAT_A`就会留下A的内网地址和外网地址的**映射关系**，server也拿到了A对应的外网IP地址和端口。
- **step3和4**: B的操作和A一样，主动连第三方server，`NAT_B`内留下B的内网地址和外网地址的**映射关系**，然后server也拿到了B对应的外网IP地址和端口。
- **step5和step6以及step7**: 此时server发消息给A，**让A主动发`UDP`消息到B的外网IP地址和端口**。此时NAT_B收到这个A的UDP数据包时，这时候根据NAT_B的设置不同，导致这时候有可能NAT_B能直接转发数据到B，那此时A和B就通了。但也有可能不通，直接丢包，不过丢包没关系，这个操作的**目的是给NAT_A上留下有关B的映射关系**。
- **step8和step9以及step10**: 跟step5一样熟悉的配方，此时server再发消息给B，让B主动发`UDP`消息到A的外网IP地址和端口。NAT_B上也留下了关于A到映射关系，这时候由于之前NAT_A上有过关于B的映射关系，此时NAT_A就能正常接受B的数据包，并将其转发给A。到这里A和B就能正常进行数据通信了。这就是所谓的**NAT打洞**。
- **step11**: 注意，之前我们都是用的**UDP数据包**，目的只是为了在两个局域网的NAT上**打个洞**出来，实际上大部分应用用的都是TCP连接，所以，这时候我们还需要在A主动向B发起TCP连接。到此，我们就完成了两端之间的通信。

<img src="https://github.com/likang315/Network/blob/master/01：计算机网络/photos/nat-direct.png?raw=true" alt="nat-direct" style="zoom:67%;" />