### SSH 

------

##### 01：概述

- SSH 协议使用加密来保护客户端和服务器（C/S）之间的连接。所有用户身份验证、命令、输出和文件传输都经过加密（**建立隧道**），以防止网络中的攻击。
- 应用：服务器登录

##### 02：远程登录

- SSH的默认端口是22，也就是说，你的登录请求会送进远程主机的22端口。使用p参数，可以修改这个端口。

- ```sh
  ssh -p 2222 user@host
  ```

- **中间人攻击**
  1. 远程主机收到用户的登录请求，把自己的公钥发给用户；
  2. 用户使用这个公钥，将登录密码加密后，发送回来；
  3. 远程主机用自己的私钥，解密登录密码，如果密码正确，就同意用户登录。
  4. 如果攻击者插在用户与远程主机之间，用**伪造的公钥**，获取用户的登录密码。再用这个密码登录远程主机，那么SSH的安全机制就荡然无存，伪造公钥不需要远程主机的私钥解密；


###### 口令登录

- 客户端填写用户名密码**发起远程登陆**；
- 远端服务器收到登陆请求后，会**将本地的一个公钥发送给客户端**；
- 客户端收到公钥后，将自己的登陆信息用远端服务器的公钥加密，并将加密后的结果发送给远端服务器。
- 远端服务器收到登陆密文后，用本地**私钥解密，拿到登陆信息到数据库比较**。登陆信息无误时，显示登陆成功。有误时就报错。
- 登陆成功后，**客户端将会将远端服务器的公钥保存到本地**，等下次再登陆时，客户端检测到收到的公钥已经在本地存在（通常保存的目录：（$HOME/.ssh/known_hosts），就不会报警告。
  - **警告**： 在密码登陆进行到第2步时，客户端收到了服务器的公钥，但是不确定这个公钥到底是不是要访问的目标服务器（也可能时中间攻击者，发送过来的假公钥）。

###### 公钥登录【免密登录】

- 客户端在**本地生成一对公私钥**；
- 将客户端本地生成的**公钥手动添加到远端服务器上**；
- 客户端发起登陆请求到远端服务器；
- 远端服务器收到请求后，会本地**生成一串随机字符，并将该随机字符串发送给客户端**；
- 客户端收到远端服务器的随机字符串后，**用本地私钥加密，并将密文传给远端服务器**；
- 远端服务器将收到的密文**用保存的客户端公钥解密，并将解密结果与原随机字符串对比**，若一致的话证明客户端可信，允许登陆。
  - ssh-copy-id ip：将你的公共密钥传输到一个远程机器上的authorized_keys文件中；
    - ssh-copy-id -i id 公钥路径 ip
  - authorized_keys 文件
    - 远程主机将用户的公钥，保存在登录后的用户主目录的$HOME/.ssh/authorized_keys文件中。公钥就是一段字符串，只要把它追加在authorized_keys文件的末尾就行了。

##### 03：SSH 命令

- ssh  [user@]host [command]
  - -A：开启认证代理连接转发功能；
  - -a：关闭认证代理连接转发功能；
  - -b：使用本机指定地址作为对应连接的源ip地址；
  - **-C**：请求压缩所有数据；
  - -F：指定ssh指令的配置文件；
  - -f：后台执行ssh指令；
  - -g：允许远程主机连接主机的转发端口；
  - -i：指定身份文件；
  - -l：指定连接远程服务器登录用户名；
  - **-N**：不执行远程指令；
  - -o：指定配置选项；
  - -p：指定远程服务器上的端口；
  - **-q**：静默模式；
  - -X：开启X11转发功能；
  - -x：关闭X11转发功能；
  - -y：开启信任X11转发功能。

##### 04：SSH 文件配置

- Host：定义连接的别名
- Hostname：需要连接的主机名或IP；
- Port：指定连接目标主机的某个端口；
- User：指定用户连接；
- IdentityFile：使用密钥所在的位置；
- **AddKeysToAgent**：是否允许自动将密钥添加到ssh-agent中，相当于ssh add；
- **ProxyCommand**：指定连接目标服务器需要执行的命令；
- **LocalCommand**：表示当成功连接目标主机时，本地立即执行的命令；
-  PermitLocalCommand：是否允许执行本机命令，默认no；
  -  PermitLocalCommand yes
- ForwardAgent：表示是否允许**验证身份代理的连接**转发到远程服务器；
- **LocalForward**：表示本地计算机上的TCP端口通过安全通道从**远程计算机（SSH Server）转发到指定的主机和端口**；
  - 第一个参数必须是本地Ip：本地Port，第二个参数必须为目标host：目标port。

##### 0：SSH 隧道

- -W host:port
  - 将client过来的标准输入和输出**forward到host和port指定的地方**。
  - -W %h:%p ：%p表示转发到目标机的端口，使用%h和%p可以保证在Hostname和Port变化的情况下不用跟着变化。

##### 06：端口转发示例

- ```shell
  # 堡垒机域名 
  Host login
   Hostname 堡垒机域名
   User likang
   Port 1000
   ForwardAgent yes
   AddKeysToAgent yes
   IdentityFile ~/.ssh/rsa_pub
  
  # 跳板机
  Host cm-jump
   Hostname cm-jump的ip
   User likang
   Port 1000
   ProxyCommand ssh login -q -W %h:%p
   ForwardAgent yes
  
  # 视频下载代理
  Host mysql-atlantis
   Hostname 代理IP(ssh server)
   User likang
   Port 1000
   ProxyCommand ssh cm-jump nc %h %p
   ForwardAgent yes
   LocalForward 127.0.0.1:3336 目标数据里IP:3306
  ```

  







